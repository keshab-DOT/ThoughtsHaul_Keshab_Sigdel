@page "/calendar"
@using MauiApp1.Models
@using MauiApp1.Services
@inject JournalService JService
@inject AppState State
@inject NavigationManager Nav
@inject IJSRuntime JS
@implements IDisposable

<div class="min-h-screen transition-colors duration-500 overflow-x-hidden
            @(State.IsDarkMode ? "bg-[#050505] text-slate-100" : "bg-[#fcfcfd] text-slate-900")">

    <div class="max-w-5xl mx-auto p-6 md:p-12">

        @* --- HEADER SECTION --- *@
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-12">
            <div>
                <span class="text-[10px] font-black uppercase tracking-[0.3em] text-[#E45D25]">Journal History</span>
                <h1 class="text-4xl font-black tracking-tighter">@currentMonth.ToString("MMMM yyyy")</h1>
            </div>

            <div class="flex items-center bg-white dark:bg-white/5 p-1.5 rounded-2xl border border-slate-200 dark:border-white/10 shadow-sm">
                <button @onclick="PrevMonth" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-white/10 transition-all">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <div class="h-4 w-[1px] bg-slate-200 dark:bg-white/10 mx-2"></div>
                <button @onclick="NextMonth" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-white/10 transition-all">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

        @* --- CALENDAR GRID --- *@
        <div class="grid grid-cols-7 gap-3 md:gap-4">
            @foreach (var day in daysOfWeek)
            {
                <div class="text-center text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2">@day</div>
            }

            @for (int i = 0; i < emptySlots; i++)
            {
                <div class="aspect-square"></div>
            }

            @foreach (var date in daysInMonth)
            {
                bool hasEntry = entryDates.Contains(date.Date);
                bool isToday = date.Date == DateTime.Today;
                bool isSelected = selectedDate == date.Date;

                <div @onclick="() => SelectDate(date)"
                     class="group relative aspect-square flex flex-col items-center justify-center rounded-2xl md:rounded-[24px] cursor-pointer transition-all duration-300 border
                                @(isSelected ? "bg-indigo-600 border-indigo-600 shadow-lg shadow-indigo-500/40" :
                                                   isToday ? "border-[#E45D25] bg-[#E45D25]/5" :
                                                   "bg-white dark:bg-[#0a0a0a] border-slate-100 dark:border-white/5 hover:border-indigo-400 dark:hover:border-indigo-500/50")">

                <span class="text-sm font-bold z-10 @(isSelected ? "text-white" : "text-slate-600 dark:text-slate-300")">
                    @date.Day
                </span>

                @if (hasEntry)
                    {
                        @* Entry Indicator: A subtle glow ring *@
                        <div class="absolute inset-2 rounded-xl md:rounded-[18px] border-2 border-emerald-500/20 group-hover:border-emerald-500/50 transition-colors"></div>
                        <div class="absolute bottom-2 w-1 h-1 bg-emerald-500 rounded-full shadow-[0_0_8px_#10b981]"></div>
                    }
                </div>
            }
        </div>

        @* --- PREVIEW DRAWER --- *@
        <div class="mt-12 transition-all duration-500 @(previewEntry is null ? "opacity-0 translate-y-10" : "opacity-100 translate-y-0")">
            @if (previewEntry is not null)
            {
                <div class="relative overflow-hidden p-8 md:p-10 rounded-[40px] border @(State.IsDarkMode ? "bg-[#0a0a0a] border-white/5" : "bg-white border-slate-200/60 shadow-xl shadow-slate-200/40")">

                    @* Decorative background accent *@
                    <div class="absolute -right-20 -top-20 w-64 h-64 bg-indigo-500/5 blur-[80px] rounded-full"></div>

                    <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-3 py-1 rounded-full bg-indigo-500/10 text-indigo-500 text-[10px] font-black uppercase tracking-wider">
                                    Reflection
                                </span>
                                <span class="text-xs font-bold text-slate-400">
                                    @selectedDate?.ToString("MMMM dd, yyyy")
                                </span>
                            </div>
                            <h2 class="text-3xl font-black tracking-tight">@previewEntry.Title</h2>
                        </div>

                        <button @onclick="HandleEdit"
                                class="flex items-center gap-2 px-6 py-3 rounded-2xl bg-slate-900 dark:bg-indigo-600 text-white font-bold text-sm hover:scale-105 active:scale-95 transition-all shadow-lg shadow-indigo-500/20">
                            <i class="bi bi-pencil-square"></i>
                            Edit Entry
                        </button>
                    </div>

                    <div class="relative z-10 mt-8 prose dark:prose-invert max-w-none text-slate-500 dark:text-slate-400 leading-relaxed italic border-l-4 border-slate-100 dark:border-white/5 pl-6">
                        @((MarkupString)previewEntry.Content)
                    </div>
                </div>
            }
            else if (selectedDate.HasValue)
            {
                @* Empty State for selected date *@
                <div class="p-12 rounded-[40px] border-2 border-dashed border-slate-200 dark:border-white/5 text-center">
                    <p class="text-slate-400 font-bold italic">No entry found for @selectedDate?.ToString("MMM dd").</p>
                    <button @onclick='() => Nav.NavigateTo("/newentry")' class="mt-4 text-indigo-500 font-black text-sm uppercase tracking-widest hover:underline">
                        + Create One
                    </button>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private DateTime currentMonth = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
    private DateTime? selectedDate;
    private List<DateTime> daysInMonth = new();
    private List<DateTime> entryDates = new();
    private JournalEntry? previewEntry;
    private int emptySlots;

    private readonly string[] daysOfWeek = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };

    protected override async Task OnInitializedAsync()
    {
        State.OnChange += StateHasChanged;
        await LoadCalendar();
    }

    private async Task LoadCalendar()
    {
        entryDates = await JService.GetEntryDates();
        daysInMonth.Clear();

        var firstDay = new DateTime(currentMonth.Year, currentMonth.Month, 1);
        emptySlots = (int)firstDay.DayOfWeek;

        int daysCount = DateTime.DaysInMonth(currentMonth.Year, currentMonth.Month);
        for (int i = 0; i < daysCount; i++)
        {
            daysInMonth.Add(firstDay.AddDays(i));
        }
    }

    private async Task SelectDate(DateTime date)
    {
        selectedDate = date.Date;
        previewEntry = await JService.GetEntryByDate(date);
    }

    private async Task NextMonth()
    {
        currentMonth = currentMonth.AddMonths(1);
        previewEntry = null;
        await LoadCalendar();
    }

    private async Task PrevMonth()
    {
        currentMonth = currentMonth.AddMonths(-1);
        previewEntry = null;
        await LoadCalendar();
    }

    private void HandleEdit()
    {
        if (previewEntry is not null)
        {
            Nav.NavigateTo($"/newentry/{previewEntry.Id}");
        }
    }

    public void Dispose()
    {
        State.OnChange -= StateHasChanged;
    }
}