@page "/"
@using MauiApp1.Models
@using MauiApp1.Services
@inject JournalService JService
@inject AppState State
@inject AuthService Auth
@inject IJSRuntime JS
@inject NavigationManager Nav
@implements IDisposable

@* MAIN CONTAINER 
   - Smooth transition between Light/Dark modes
   - Custom 'antialiased' for sharper text
*@
<div class="flex h-screen overflow-hidden antialiased transition-colors duration-700
            @(State.IsDarkMode ? "bg-[#050505] text-slate-100" : "bg-[#f8fafc] text-slate-900")">

    <main class="flex-1 flex flex-col min-w-0 overflow-y-auto scroll-smooth">

        @* --- STICKY NEURAL HEADER --- *@
        <header class="sticky top-0 z-50 px-8 py-5 flex items-center justify-between border-b backdrop-blur-md
                       @(State.IsDarkMode ? "bg-[#050505]/80 border-white/5" : "bg-white/80 border-slate-200/60")">

            <div class="flex items-center gap-10">
                <div class="flex flex-col">
                    <span class="text-[10px] font-black uppercase tracking-[0.3em] text-[#E45D25]">Insights</span>
                    <h2 class="text-2xl font-black tracking-tight italic">Thoughtshaul</h2>
                </div>

                @* Modern Range Selector *@
                <div class="hidden sm:flex p-1 rounded-2xl bg-slate-100 dark:bg-white/5 border border-slate-200 dark:border-white/10">
                    @foreach (int day in new[] { 7, 30, 90 })
                    {
                        <button @onclick="() => SetDays(day)"
                                class="px-5 py-1.5 rounded-xl text-xs font-bold transition-all duration-300
                                           @(selectedDays == day ? "bg-white dark:bg-indigo-600 shadow-md text-indigo-600 dark:text-white" : "text-slate-500 hover:text-slate-800 dark:hover:text-slate-200")">
                            @(day)D
                        </button>
                    }
                </div>
            </div>

            <div class="flex items-center gap-3">
                @* Circular Toggle *@
                <button @onclick="State.ToggleDarkMode"
                        class="group relative w-12 h-12 flex items-center justify-center rounded-full border border-slate-200 dark:border-white/10 transition-all hover:bg-white dark:hover:bg-white/5">
                    <i class="bi @(State.IsDarkMode ? "bi-moon-stars text-indigo-400" : "bi-sun text-orange-500") text-lg transition-transform group-hover:rotate-12"></i>
                </button>

                @* Primary Action Button *@
                <button @onclick='() => Nav.NavigateTo("newentry")'
                        class="h-12 px-6 rounded-2xl bg-slate-900 dark:bg-indigo-600 text-white font-bold text-sm
                               flex items-center gap-2 transition-all hover:shadow-[0_0_20px_rgba(79,70,229,0.4)] active:scale-95">
                    <i class="bi bi-plus-lg"></i>
                    <span class="hidden md:inline">New Entry</span>
                </button>
            </div>
        </header>

        <div class="p-8 max-w-7xl mx-auto w-full space-y-10">

            @* --- STATS GRID --- *@
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                @StatCard("Streak", stats.CurrentStreak.ToString(), "Active Days", "bi-fire", "bg-orange-500/10 text-orange-500")
                @StatCard("Personal Best", stats.LongestStreak.ToString(), "All-time", "bi-trophy", "bg-yellow-500/10 text-yellow-500")
                @StatCard("Volume", stats.AverageWords.ToString(), "Avg Words", "bi-pencil-square", "bg-blue-500/10 text-blue-500")
                @StatCard("Days Gapped", analyticsData.MissedDaysCount.ToString(), "Missed", "bi-exclamation-circle", "bg-rose-500/10 text-rose-500")
            </div>

            @* --- ANALYTICS DASHBOARD --- *@
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">

                @* MOOD CARD (4/12 width) *@
                <div class="lg:col-span-4 p-8 rounded-[40px] border transition-all duration-500
                            @(State.IsDarkMode ? "bg-[#0a0a0a] border-white/5 hover:border-indigo-500/30 shadow-2xl" : "bg-white border-slate-200/60 shadow-xl shadow-slate-200/40")">
                    <div class="flex justify-between items-center mb-10">
                        <h4 class="text-xs font-black uppercase tracking-widest text-slate-400">Emotional Balance</h4>
                        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    </div>

                    <div class="h-64 w-full flex items-center justify-center relative">
                        <canvas id="moodDoughnutChart"></canvas>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Dominant</span>
                            <span class="text-2xl font-black @GetMoodColor(analyticsData.MostFrequentMood)">@analyticsData.MostFrequentMood</span>
                        </div>
                    </div>
                </div>

                @* TREND CARD (8/12 width) *@
                <div class="lg:col-span-8 p-8 rounded-[40px] border transition-all duration-500
                            @(State.IsDarkMode ? "bg-[#0a0a0a] border-white/5 hover:border-indigo-500/30 shadow-2xl" : "bg-white border-slate-200/60 shadow-xl shadow-slate-200/40")">
                    <div class="flex justify-between items-center mb-10">
                        <h4 class="text-xs font-black uppercase tracking-widest text-slate-400">Writing Momentum</h4>
                        <div class="flex items-center gap-2 text-xs font-bold text-indigo-500">
                            <i class="bi bi-graph-up"></i> Word Count
                        </div>
                    </div>
                    <div class="h-[320px]">
                        <canvas id="wordTrendChart"></canvas>
                    </div>
                </div>
            </div>

            @* --- FOCUS & CONCEPTS --- *@
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

                @* Categories Card *@
                <div class="p-10 rounded-[40px] @(State.IsDarkMode ? "bg-white/[0.03]" : "bg-slate-100/50") border border-transparent">
                    <h4 class="text-xs font-black uppercase tracking-widest mb-8 text-slate-400">Top Categories</h4>
                    <div class="space-y-6">
                        @foreach (var cat in analyticsData.CategoryBreakdown)
                        {
                            <div class="group">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs font-bold uppercase tracking-tight">@cat.Key</span>
                                    <span class="text-xs font-black text-indigo-500 group-hover:scale-110 transition-transform">@cat.Value%</span>
                                </div>
                                <div class="h-2 w-full bg-slate-200 dark:bg-white/10 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 transition-all duration-1000 ease-out shadow-[0_0_8px_rgba(99,102,241,0.4)]"
                                         style="width: @(cat.Value)%"></div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                @* Tag Cloud Card *@
                <div class="p-10 rounded-[40px] border @(State.IsDarkMode ? "bg-[#0a0a0a] border-white/5" : "bg-white border-slate-200/60 shadow-sm")">
                    <h4 class="text-xs font-black uppercase tracking-widest mb-8 text-slate-400">Mind Tags</h4>
                    <div class="flex flex-wrap gap-3">
                        @foreach (var tag in analyticsData.TopTags)
                        {
                            <button class="px-5 py-2.5 rounded-2xl text-xs font-bold border transition-all
                                               @(State.IsDarkMode ? "bg-white/5 border-white/5 hover:bg-indigo-600 hover:text-white" : "bg-slate-50 border-slate-200 hover:border-indigo-500 hover:text-indigo-600")">
                                #@tag.Key <span class="ml-1 opacity-40">@tag.Value</span>
                            </button>
                        }
                    </div>
                </div>
            </div>

            @* --- MISSED DAYS (DASHED FOOTER) --- *@
            @if (analyticsData.MissedDates.Any())
            {
                <div class="p-10 rounded-[40px] border-2 border-dashed @(State.IsDarkMode ? "border-rose-500/10 bg-rose-500/[0.02]" : "border-rose-200 bg-rose-50/30")">
                    <div class="flex items-center gap-4 mb-8">
                        <i class="bi bi-calendar-x text-rose-500 text-xl"></i>
                        <h4 class="text-xs font-black uppercase tracking-[0.2em] text-rose-500">Missed Gaps</h4>
                    </div>
                    <div class="flex flex-wrap gap-4">
                        @foreach (var date in analyticsData.MissedDates.Take(15))
                        {
                            <div class="flex flex-col items-center gap-2 group cursor-default">
                                <div class="w-12 h-12 rounded-2xl flex items-center justify-center font-black text-sm transition-all duration-300
                                                    @(State.IsDarkMode ? "bg-black border border-white/10 text-slate-500 group-hover:border-rose-500/50 group-hover:text-rose-500" : "bg-white border border-slate-200 text-slate-400 group-hover:border-rose-500 group-hover:text-rose-500")">
                                    @date.Day
                                </div>
                                <span class="text-[9px] font-bold uppercase tracking-tighter text-slate-500">@date.ToString("MMM")</span>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </main>
</div>

@code {
    private DashboardStats stats = new();
    private AnalyticsData analyticsData = new();
    private int selectedDays = 30;
    private bool shouldUpdateCharts = false;

    protected override async Task OnInitializedAsync()
    {
        State.OnChange += StateHasChanged;
        if (!Auth.IsLoggedIn) { Nav.NavigateTo("/login", true); return; }
        await RefreshData();
    }

    private async Task RefreshData()
    {
        stats = await JService.GetDashboardStats(selectedDays);
        analyticsData = await JService.GetAnalyticsData(selectedDays);
        shouldUpdateCharts = true;
        StateHasChanged();
    }

    private async Task SetDays(int days)
    {
        selectedDays = days;
        await RefreshData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (shouldUpdateCharts)
        {
            shouldUpdateCharts = false;
            await Task.Delay(150); // Small wait for DOM alignment
            await JS.InvokeVoidAsync("setupDashboardAnalytics",
                analyticsData.SentimentLabels, analyticsData.SentimentCounts,
                analyticsData.TrendLabels, analyticsData.TrendCounts,
                State.IsDarkMode);
        }
    }

    private string GetMoodColor(string mood)
    {
        if (string.IsNullOrEmpty(mood) || mood == "No Data") return "text-slate-400";
        var pos = new[] { "Happy", "Excited", "Relaxed", "Grateful", "Confident" };
        var neg = new[] { "Sad", "Angry", "Stressed", "Lonely", "Anxious" };
        if (pos.Contains(mood)) return "text-emerald-500";
        if (neg.Contains(mood)) return "text-rose-500";
        return "text-indigo-500";
    }

    public void Dispose() => State.OnChange -= StateHasChanged;

    @* Reusable Component Fragment *@
    RenderFragment StatCard(string title, string value, string subtitle, string icon, string colorClass) => __builder =>
    {
        <div class="group relative p-6 rounded-[32px] border transition-all duration-300 overflow-hidden
                            @(State.IsDarkMode ? "bg-[#0a0a0a] border-white/5 hover:border-indigo-500/20" : "bg-white border-slate-200/60 hover:border-indigo-300")">

            @* Background Accent Glow *@
            <div class="absolute -right-4 -top-4 w-20 h-20 blur-3xl opacity-0 group-hover:opacity-20 transition-opacity @colorClass.Split(' ')[0]"></div>

            <div class="relative z-10 flex flex-col gap-5">
                <div class="w-10 h-10 rounded-2xl flex items-center justify-center @colorClass">
                    <i class="bi @icon text-lg"></i>
                </div>
                <div>
                    <h5 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">@title</h5>
                    <div class="flex items-baseline gap-2">
                        <span class="text-3xl font-black tracking-tighter">@value</span>
                        <span class="text-[10px] font-bold text-slate-500">@subtitle</span>
                    </div>
                </div>
            </div>
        </div>
    };
}