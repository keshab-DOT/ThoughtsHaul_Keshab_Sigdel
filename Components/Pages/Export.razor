@page "/export"
@using MauiApp1.Models
@using MauiApp1.Services
@inject JournalService JService
@inject AppState State
@inject IJSRuntime JS
@implements IDisposable

<div class="min-h-screen p-8 max-w-5xl mx-auto animate-in fade-in duration-500 @(State.IsDarkMode ? "bg-[#0f172a]" : "bg-gray-50") print:bg-white print:p-0">

    @* --- UI HEADER --- *@
    <div class="mb-8 print:hidden flex justify-between items-end">
        <div>
            <h1 class="text-3xl font-black @(State.IsDarkMode ? "text-white" : "text-slate-800")">Export Journals</h1>
            <p class="@(State.IsDarkMode ? "text-slate-400" : "text-gray-500")">Select entries to generate your PDF scrapbook.</p>
        </div>

        <div class="flex gap-3">
            <button @onclick="ToggleSelectAll" class="px-4 py-2 rounded-xl border font-bold text-sm transition-all @(State.IsDarkMode ? "border-slate-700 text-slate-300 hover:bg-slate-800" : "border-gray-200 text-gray-600 hover:bg-white")">
                @(selectedIds.Count == allEntries.Count ? "Deselect All" : "Select All")
            </button>

            @if (selectedIds.Any())
            {
                <button @onclick="ExportAsPdf" class="flex items-center gap-3 px-8 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-2xl font-bold shadow-xl shadow-red-500/20 hover:scale-105 active:scale-95 transition-all">
                    <i class="bi bi-file-earmark-pdf-fill text-xl"></i>
                    <span>Export (@selectedIds.Count)</span>
                </button>
            }
        </div>
    </div>

    @* --- SELECTION LIST --- *@
    <div class="grid gap-4 print:hidden">
        @foreach (var entry in FilteredEntries)
        {
            <div @onclick="() => ToggleSingle(entry.Id)"
                 class="group relative flex items-center gap-4 p-5 rounded-3xl border-2 cursor-pointer transition-all
                     @(selectedIds.Contains(entry.Id)
                                     ? (State.IsDarkMode ? "border-orange-500 bg-orange-500/10" : "border-orange-400 bg-orange-50")
                                     : (State.IsDarkMode ? "border-slate-800 bg-slate-900/50 hover:border-slate-700" : "border-white bg-white shadow-sm hover:border-gray-200"))">

                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all
                         @(selectedIds.Contains(entry.Id) ? "bg-orange-500 border-orange-500" : "border-gray-300")">
                    @if (selectedIds.Contains(entry.Id))
                    {
                        <i class="bi bi-check-lg text-white text-xs"></i>
                    }
                </div>

                <div class="flex-1">
                    <div class="text-xs font-black uppercase tracking-widest @(State.IsDarkMode ? "text-slate-500" : "text-gray-400")">
                        @entry.EntryDate.ToString("ddd, MMM dd, yyyy")
                    </div>
                    <div class="text-lg font-bold @(State.IsDarkMode ? "text-white" : "text-slate-700")">@entry.Title</div>
                </div>

                <div class="flex items-center gap-3">
                    <span class="text-2xl">@GetMoodEmoji(entry.PrimaryMood)</span>
                    <button @onclick:stopPropagation="true" @onclick="() => ExportSingle(entry.Id)"
                            class="p-3 rounded-2xl transition-all @(State.IsDarkMode ? "bg-slate-800 text-slate-400 hover:text-white" : "bg-gray-100 text-gray-400 hover:bg-orange-500 hover:text-white")">
                        <i class="bi bi-printer-fill"></i>
                    </button>
                </div>
            </div>
        }
    </div>

    @* --- PRINT TEMPLATE (Hidden on Screen) --- *@
    <div id="export-area">
        @foreach (var entry in EntriesToPrint)
        {
            <div class="entry-card" style="border-color: @GetMoodColor(entry.PrimaryMood);">
                <div class="flex justify-between items-start mb-8">
                    <div>
                        <div class="flex items-center gap-4 mb-2">
                            <span class="text-6xl">@GetMoodEmoji(entry.PrimaryMood)</span>
                            <div>
                                <p class="text-sm font-black uppercase tracking-widest" style="color: @GetMoodColor(entry.PrimaryMood)">
                                    Primary: @entry.PrimaryMood
                                </p>
                                <h1 class="text-4xl font-black text-slate-900">@entry.Title</h1>
                            </div>
                        </div>
                        <p class="text-slate-400 font-bold ml-20">@entry.EntryDate.ToString("dddd, MMMM dd, yyyy")</p>
                    </div>
                    <div class="text-right">
                        <span class="px-5 py-2 rounded-2xl bg-slate-900 text-white text-xs font-black tracking-widest uppercase">
                            @(string.IsNullOrEmpty(entry.Category) ? "Personal" : entry.Category)
                        </span>
                    </div>
                </div>

                @* SECONDARY MOODS *@
                <div class="ml-20 mb-8 flex flex-wrap gap-3">
                    @if (!string.IsNullOrEmpty(entry.SecondaryMoods))
                    {
                        @foreach (var sm in entry.SecondaryMoods.Split(','))
                        {
                            <div class="flex items-center gap-2 px-4 py-2 bg-white rounded-2xl shadow-sm border border-slate-100">
                                <span class="text-xl">@GetMoodEmoji(sm.Trim())</span>
                                <span class="text-xs font-bold text-slate-600">@sm.Trim()</span>
                            </div>
                        }
                    }
                </div>

                <div class="ml-20">
                    <div class="prose prose-slate prose-lg max-w-none text-slate-700 leading-relaxed mb-10 border-l-2 border-slate-100 pl-6">
                        @((MarkupString)entry.Content)
                    </div>
                    <div class="flex flex-wrap gap-2">
                        @if (!string.IsNullOrEmpty(entry.Tags))
                        {
                            @foreach (var tag in entry.Tags.Split(','))
                            {
                                <span class="px-4 py-1.5 bg-white border-2 border-slate-100 rounded-xl text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                    #@tag.Trim()
                                </span>
                            }
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private List<JournalEntry> allEntries = new();
    private HashSet<int> selectedIds = new();
    private List<JournalEntry> EntriesToPrint = new();

    protected override async Task OnInitializedAsync()
    {
        allEntries = await JService.GetAllEntries();
        State.OnChange += StateHasChanged;
    }

    private IEnumerable<JournalEntry> FilteredEntries => allEntries.OrderByDescending(e => e.EntryDate);

    private string GetMoodEmoji(string mood) => mood?.Trim().ToLower() switch
    {
        "happy" => "😊",
        "excited" => "🤩",
        "relaxed" => "😌",
        "grateful" => "🙏",
        "confident" => "💪",
        "calm" => "🍃",
        "thoughtful" => "🤔",
        "curious" => "🧐",
        "nostalgic" => "⏳",
        "bored" => "😑",
        "sad" => "😢",
        "angry" => "😡",
        "stressed" => "😫",
        "lonely" => "👤",
        "anxious" => "😰",
        _ => "📝"
    };

    private string GetMoodColor(string mood) => mood?.Trim().ToLower() switch
    {
        "happy" or "excited" => "#FFD93D",
        "relaxed" or "grateful" or "calm" => "#6BCB77",
        "confident" or "thoughtful" => "#4D96FF",
        "sad" or "lonely" or "anxious" => "#A2B5BB",
        "angry" or "stressed" => "#FF6B6B",
        _ => "#EEF2F7"
    };

    private void ToggleSingle(int id)
    {
        if (selectedIds.Contains(id)) selectedIds.Remove(id);
        else selectedIds.Add(id);
    }

    private void ToggleSelectAll()
    {
        if (selectedIds.Count == allEntries.Count) selectedIds.Clear();
        else selectedIds = new HashSet<int>(allEntries.Select(e => e.Id));
    }

    private async Task ExportSingle(int id)
    {
        EntriesToPrint = allEntries.Where(e => e.Id == id).ToList();
        await TriggerPrint();
    }

    private async Task ExportAsPdf()
    {
        EntriesToPrint = allEntries.Where(e => selectedIds.Contains(e.Id)).OrderByDescending(x => x.EntryDate).ToList();
        await TriggerPrint();
    }

    private async Task TriggerPrint()
    {
        StateHasChanged();
        await Task.Delay(400);
        await JS.InvokeVoidAsync("window.print");
    }

    public void Dispose() => State.OnChange -= StateHasChanged;
}